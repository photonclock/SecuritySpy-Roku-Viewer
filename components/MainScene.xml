<?xml version="1.0" encoding="utf-8" ?>
<component name="MainScene" extends="Scene">
    <script type="text/brightscript">
        <![CDATA[
        sub init()
            print ">>> [MainScene] INIT STARTED"
            
            ' Set Background to Black
            m.top.backgroundColor = "0x000000FF"
            m.top.backgroundUri = ""
            
            ' --- NODES ---
            m.landingGroup = m.top.findNode("landingGroup")
            m.landingButtons = m.top.findNode("landingButtons")
            m.startButton = m.top.findNode("btnStart")
            
            m.configGroup = m.top.findNode("configGroup")
            m.configButtons = m.top.findNode("configButtons")
            m.statusLabel = m.top.findNode("statusLabel")
            
            m.camSelectGroup = m.top.findNode("camSelectGroup")
            m.camGrid = m.top.findNode("camGrid")
            m.doneBtn = m.top.findNode("doneBtn")
            
            m.videoScene = m.top.findNode("videoScene")
            
            print ">>> [MainScene] Nodes Found"

            ' --- STATE DATA ---
            m.regSec = CreateObject("roRegistrySection", "SecuritySpy")
            
            ip = m.regSec.Read("ip")
            if ip = invalid then ip = ""
            port = m.regSec.Read("port")
            if port = invalid then port = ""
            https = m.regSec.Read("useHttps")
            if https = invalid then https = "false"

            auth = m.regSec.Read("auth")
            if auth = invalid then auth = ""
            
            speed = m.regSec.Read("refreshSpeed")
            if speed = invalid then speed = "1"
            
            aspect = m.regSec.Read("maintainAspect")
            if aspect = invalid then aspect = "true"

            tvRes = m.regSec.Read("tvResolution")
            if tvRes = invalid then tvRes = "1920"
            
            borders = m.regSec.Read("showBorders")
            if borders = invalid then borders = "true"
                        
            cams = m.regSec.Read("selectedCams")
            if cams = invalid then cams = ""

            m.config = {
                ip: ip,
                port: port,
                auth: auth,
                refreshSpeed: speed,
                maintainAspect: aspect,
                tvResolution: tvRes,
                showBorders: borders,
                useHttps: https,
                selectedCams: cams
            }
            
            m.isAutoValidation = false
            
            print ">>> [MainScene] Registry Loaded: IP=" + m.config.ip
            
            if m.config.port = "" then m.config.port = "8070"
            
            m.editingField = "" 
            m.availableCams = [] 
            
            ' --- SETUP CONTENT PROGRAMMATICALLY ---
            print ">>> [MainScene] Setting up Content"
            
            landingContent = CreateObject("roSGNode", "ContentNode")
            landingContent.createChild("ContentNode").title = "Start Stream"
            landingContent.createChild("ContentNode").title = "Configure"
            m.landingButtons.content = landingContent
            
            configContent = CreateObject("roSGNode", "ContentNode")
            configContent.createChild("ContentNode").title = "Server IP: " + m.config.ip
            configContent.createChild("ContentNode").title = "Port: " + m.config.port
            configContent.createChild("ContentNode").title = "Use HTTPS: " + m.config.useHttps
            
            ' Mask Initial Load
            maskedAuth = "****"
            if m.config.auth.Len() > 4
                maskedAuth = m.config.auth.Left(2) + "****" + m.config.auth.Right(2)
            end if
            configContent.createChild("ContentNode").title = "Auth String: " + maskedAuth
            
            configContent.createChild("ContentNode").title = "Refresh Rate: " + getSpeedLabel(m.config.refreshSpeed)
            configContent.createChild("ContentNode").title = "Maintain Aspect: " + m.config.maintainAspect
            configContent.createChild("ContentNode").title = "TV Resolution: " + m.config.tvResolution
            configContent.createChild("ContentNode").title = "Show Debug Borders: " + m.config.showBorders
            configContent.createChild("ContentNode").title = "Select Cameras"
            m.configButtons.content = configContent
            
            ' --- SETUP OBSERVERS ---
            m.landingButtons.observeField("itemSelected", "onLandingSelect")
            m.configButtons.observeField("itemSelected", "onConfigSelect")
            m.camGrid.observeField("itemSelected", "onCamGridSelect")
            m.doneBtn.observeField("buttonSelected", "onDoneSelect")
            
            ' Initial State
            print ">>> [MainScene] Checking Config Status"
            checkConfigStatus()
            
            print ">>> [MainScene] Showing Landing"
            showLanding()
            
            print ">>> [MainScene] INIT COMPLETE"
        end sub

        function getSpeedLabel(val) as String
            return val + " FPS"
        end function

        ' --- NAVIGATION HELPERS ---
        sub showLanding()
            m.landingGroup.visible = true
            m.configGroup.visible = false
            m.camSelectGroup.visible = false
            m.videoScene.visible = false
            m.videoScene.active = false
            m.landingButtons.setFocus(true)
        end sub

        sub showConfig()
            m.landingGroup.visible = false
            m.configGroup.visible = true
            m.camSelectGroup.visible = false
            
            updateConfigLabels()
            m.configButtons.setFocus(true)
            
            ' Validation on Load
            if m.config.ip = "" or m.config.port = "" or m.config.auth = ""
                m.statusLabel.color = "0xFF0000FF"
                m.statusLabel.text = "Not connected"
                removeStartStreamButton()
            else
                ' Trigger auto-validation
                m.isAutoValidation = true
                testConnection()
            end if
        end sub

        sub showCamSelect()
            m.configGroup.visible = false
            m.camSelectGroup.visible = true
            m.camGrid.setFocus(true)
        end sub

        sub startVideo()
            ' Clear UI views to prevent text bleed-through
            m.landingGroup.visible = false
            m.configGroup.visible = false
            m.camSelectGroup.visible = false
            
            m.videoScene.visible = true
            
            camArray = []
            if m.config.selectedCams <> invalid and m.config.selectedCams <> ""
                parts = m.config.selectedCams.Split(",")
                for each p in parts
                    camArray.push(p.toInt())
                end for
            end if
            
            cfg = {
                ip: m.config.ip,
                port: m.config.port,
                auth: m.config.auth,
                refreshSpeed: m.config.refreshSpeed,
                maintainAspect: m.config.maintainAspect,
                tvResolution: m.config.tvResolution,
                showBorders: m.config.showBorders,
                useHttps: m.config.useHttps,
                selectedCams: camArray
            }
            
            m.videoScene.configData = cfg
            m.videoScene.active = true
            m.videoScene.setFocus(true)
        end sub

        sub checkConfigStatus()
            if m.config.ip <> "" and m.config.auth <> "" and m.config.selectedCams <> ""
                m.startButton.opacity = 1.0
            else
                m.startButton.opacity = 0.5
            end if
        end sub

        ' --- EVENT HANDLERS ---
        sub onLandingSelect()
            idx = m.landingButtons.itemSelected
            if idx = 0 ' Start
                if m.startButton.opacity = 1.0
                    startVideo()
                else
                    m.statusLabel.text = "Please Configure First"
                    m.statusLabel.color = "0xFF0000FF"
                    showConfig()
                end if
            else if idx = 1 ' Configure
                showConfig()
            end if
        end sub

        sub onConfigSelect()
            idx = m.configButtons.itemSelected
            ' 0: IP, 1: Port, 2: HTTPS, 3: Auth, 4: Speed, 5: Maintain Aspect, 6: TV Resolution, 7: Borders, 8: Select Cameras, 9: Start Stream
            
            if idx = 0
                openKeyboardDialog("ip", "Enter Server IP", m.config.ip)
            else if idx = 1
                openKeyboardDialog("port", "Enter Port", m.config.port)
            else if idx = 2
                toggleHttps()
            else if idx = 3
                openKeyboardDialog("auth", "Enter Auth String", m.config.auth)
            else if idx = 4
                toggleSpeed()
            else if idx = 5
                toggleMaintainAspect()
            else if idx = 6
                toggleTvResolution()
            else if idx = 7
                toggleBorders()
            else if idx = 8
                m.isAutoValidation = false
                testConnection()
            else if idx = 9
                startVideo()
            end if
        end sub
        
        sub toggleSpeed()
            current = m.config.refreshSpeed
            speeds = ["1", "2", "4", "6", "8", "10", "12", "15", "16", "24", "25", "30", "36", "48", "50", "60"]
            
            nextIndex = 0
            for i = 0 to speeds.Count() - 1
                if speeds[i] = current
                    nextIndex = i + 1
                    exit for
                end if
            end for
            
            if nextIndex >= speeds.Count() then nextIndex = 0
            m.config.refreshSpeed = speeds[nextIndex]
            
            m.regSec.Write("refreshSpeed", m.config.refreshSpeed)
            m.regSec.Flush()
            updateConfigLabels()
        end sub

        sub toggleMaintainAspect()
            if m.config.maintainAspect = "true"
                m.config.maintainAspect = "false"
            else
                m.config.maintainAspect = "true"
            end if
            m.regSec.Write("maintainAspect", m.config.maintainAspect)
            m.regSec.Flush()
            updateConfigLabels()
        end sub

        sub toggleTvResolution()
            current = m.config.tvResolution
            resOptions = ["640", "1280", "1920", "3840", "4096"]
            
            nextIndex = 0
            for i = 0 to resOptions.Count() - 1
                if resOptions[i] = current
                    nextIndex = i + 1
                    exit for
                end if
            end for
            
            if nextIndex >= resOptions.Count() then nextIndex = 0
            m.config.tvResolution = resOptions[nextIndex]
            m.regSec.Write("tvResolution", m.config.tvResolution)
            m.regSec.Flush()
            updateConfigLabels()
        end sub
        
        sub toggleBorders()
            if m.config.showBorders = "true" 
                m.config.showBorders = "false" 
            else 
                m.config.showBorders = "true"
            end if
            m.regSec.Write("showBorders", m.config.showBorders)
            m.regSec.Flush()
            updateConfigLabels()
        end sub
        
        sub toggleHttps()
            if m.config.useHttps = "true" 
                m.config.useHttps = "false" 
            else 
                m.config.useHttps = "true"
            end if
            m.regSec.Write("useHttps", m.config.useHttps)
            m.regSec.Flush()
            updateConfigLabels()
            
            ' Trigger check on toggle
            if m.config.ip <> "" and m.config.port <> "" and m.config.auth <> ""
                m.isAutoValidation = true
                testConnection()
            end if
        end sub
        
        sub openKeyboardDialog(field, title, currentVal)
            m.editingField = field
            dialog = createObject("roSGNode", "KeyboardDialog")
            dialog.title = title
            dialog.text = currentVal
            dialog.buttons = ["OK", "Cancel"]
            dialog.observeField("buttonSelected", "onKeyboardDialogButton")
            dialog.observeField("wasClosed", "onKeyboardDialogClosed")
            m.top.dialog = dialog
        end sub
        
        sub onKeyboardDialogButton(msg)
            dlg = msg.getRoSGNode()
            idx = msg.getData()
            
            if idx = 0 ' OK
                val = dlg.text
                if m.editingField = "ip" then m.config.ip = val
                if m.editingField = "port" then m.config.port = val
                if m.editingField = "auth" then m.config.auth = val
                
                m.regSec.Write(m.editingField, val)
                m.regSec.Flush()
                
                updateConfigLabels()
                
                ' Validation on Exit
                if m.config.ip = "" or m.config.port = "" or m.config.auth = ""
                    m.statusLabel.color = "0xFF0000FF"
                    m.statusLabel.text = "Configuration incomplete"
                    removeStartStreamButton()
                else
                    m.isAutoValidation = true
                    testConnection()
                end if
            end if
            
            dlg.close = true
        end sub
        
        sub onKeyboardDialogClosed()
            m.configButtons.setFocus(true)
        end sub
        
        function onKeyEvent(key as String, press as Boolean) as Boolean
            if press
                if key = "back"
                    if m.videoScene.visible
                        stopVideo()
                        showLanding()
                        return true
                    else if m.camSelectGroup.visible
                        showConfig()
                        return true
                    else if m.configGroup.visible
                        showLanding()
                        return true
                    end if
                end if
                
                if m.camSelectGroup.visible
                    if m.camGrid.hasFocus()
                        if key = "down"
                            row = Int(m.camGrid.itemFocused / m.camGrid.numColumns)
                            totalRows = Int((m.camGrid.content.getChildCount() - 1) / m.camGrid.numColumns)
                            if row = totalRows
                                m.doneBtn.setFocus(true)
                                return true
                            end if
                        end if
                    else if m.doneBtn.hasFocus()
                        if key = "up"
                            m.camGrid.setFocus(true)
                            return true
                        end if
                    end if
                end if
            end if
            return false
        end function

        sub updateConfigLabels()
            c = m.configButtons.content
            c.getChild(0).title = "Server IP: " + m.config.ip
            c.getChild(1).title = "Port: " + m.config.port
            c.getChild(2).title = "Use HTTPS: " + m.config.useHttps
            
            ' MASK AUTH for display
            maskedAuth = "****"
            if m.config.auth.Len() > 4
                maskedAuth = m.config.auth.Left(2) + "****" + m.config.auth.Right(2)
            end if
            c.getChild(3).title = "Auth String: " + maskedAuth
            
            c.getChild(4).title = "Refresh Rate: " + getSpeedLabel(m.config.refreshSpeed)
            c.getChild(5).title = "Maintain Aspect: " + m.config.maintainAspect
            c.getChild(6).title = "TV Resolution: " + m.config.tvResolution
            c.getChild(7).title = "Show Debug Borders: " + m.config.showBorders
        end sub

        sub testConnection()
            m.statusLabel.text = "Connecting..."
            m.statusLabel.color = "0xFFFFFFFF" ' White/Default while connecting
            
            protocol = "http"
            if m.config.useHttps = "true" then protocol = "https"
            
            url = protocol + "://" + m.config.ip + ":" + m.config.port + "/systemInfo?format=json&auth=" + m.config.auth
            
            ' Log Sanitization
            cleanUrl = url.Replace(m.config.auth, "AUTH_KEY")
            print ">>> [Network] Connecting to: " + cleanUrl
            
            m.task = CreateObject("roSGNode", "NetworkTask")
            m.task.url = url
            m.task.observeField("response", "onConnectResponse")
            m.task.control = "RUN"
        end sub

        sub onConnectResponse(msg)
            resp = msg.getData()
            if resp.success
                print ">>> [Network] Success"
                
                ' Extract Server Name for Status Label
                sName = "Server"
                if resp.data.server <> invalid and resp.data.server["server-name"] <> invalid
                    sName = resp.data.server["server-name"]
                end if
                
                ' Update Status Label (Bright Green Success)
                m.statusLabel.color = "0x00FF00FF"
                m.statusLabel.text = sName + ": Connected"
                
                ' Enable Start Stream Option
                addStartStreamButton()
                
                ' Process List (Update Grid Content)
                processCameraList(resp.data)
                
                ' If manual triggering (e.g. "Select Cameras"), go to grid
                if not m.isAutoValidation
                    showCamSelect()
                end if
            else
                m.statusLabel.color = "0xFF0000FF"
                m.statusLabel.text = "Error: " + resp.error
                removeStartStreamButton()
            end if
        end sub

        sub processCameraList(json)
            cams = json["camera-list"]
            if cams = invalid 
                m.statusLabel.color = "0xFF0000FF"
                m.statusLabel.text = "No camera-list found."
                return
            end if
            
            protocol = "http"
            if m.config.useHttps = "true" then protocol = "https"
            
            content = CreateObject("roSGNode", "ContentNode")
            selStr = m.config.selectedCams
            if selStr = invalid then selStr = ""
            
            ' Robust split logic instead of Instr
            selectedParts = selStr.Split(",")
            
            for each cam in cams
                item = content.createChild("ContentNode")
                item.title = cam.name
                item.HDPosterUrl = protocol + "://" + m.config.ip + ":" + m.config.port + "/image?cameraNum=" + cam.number.toStr() + "&width=320&height=240&quality=40&auth=" + m.config.auth
                item.description = cam.number.toStr()
                item.AddField("selected", "boolean", false)
                
                ' Exact Match Check
                for each p in selectedParts
                    if p = cam.number.toStr()
                        item.selected = true
                        exit for
                    end if
                end for
            end for
            
            m.camGrid.content = content
        end sub
        
        sub addStartStreamButton()
            c = m.configButtons.content
            if c.getChildCount() = 9 ' Only add if it's missing (Index 9)
                c.createChild("ContentNode").title = "Start Stream"
            end if
        end sub
        
        sub removeStartStreamButton()
            c = m.configButtons.content
            if c.getChildCount() > 9 ' Remove if present
                c.removeChildIndex(9)
            end if
        end sub
        
        sub onCamGridSelect()
            idx = m.camGrid.itemSelected
            item = m.camGrid.content.getChild(idx)
            
            if item <> invalid
                newItem = item.clone(true)
                newItem.selected = not item.selected
                m.camGrid.content.replaceChild(newItem, idx)
                updateSelectedCamsString()
            end if
        end sub
        
        sub updateSelectedCamsString()
            newSel = ""
            c = m.camGrid.content
            for i = 0 to c.getChildCount() - 1
                item = c.getChild(i)
                if item.selected
                    if newSel <> "" then newSel = newSel + ","
                    newSel = newSel + item.description
                end if
            end for
            m.config.selectedCams = newSel
        end sub
        
        sub onDoneSelect()
            m.regSec.Write("selectedCams", m.config.selectedCams)
            m.regSec.Flush()
            checkConfigStatus()
            showConfig()
        end sub
        
        sub stopVideo()
            m.videoScene.visible = false
            m.videoScene.active = false
        end sub
        ]]>
    </script>

    <children>
        <Group id="landingGroup" visible="true">
            <Poster uri="pkg:/images/splash.png" width="400" height="400" translation="[760, 150]" loadDisplayMode="scaleToFit" />
            
            <LabelList id="landingButtons" translation="[800, 600]" itemSize="[320, 60]" 
                       color="0xCCCCCCFF" 
                       focusedColor="0x000000FF"
                       vertFocusAnimationStyle="floatingFocus" />
                       
            <Rectangle id="btnStart" width="10" height="10" opacity="0.5"/> 
        </Group>

        <Group id="configGroup" visible="false">
            <Label text="Configuration" translation="[100, 50]" font="font:LargeBoldSystemFont" color="0xFFFFFFFF"/>
            <Label id="statusLabel" text="" translation="[100, 100]" color="0xFF0000FF" />
            
            <LabelList id="configButtons" translation="[100, 200]" itemSize="[1000, 60]"
                       color="0xCCCCCCFF" 
                       focusedColor="0x000000FF" 
                       vertFocusAnimationStyle="floatingFocus" />
        </Group>
        
        <Group id="camSelectGroup" visible="false">
            <Label text="Select Cameras" translation="[100, 50]" font="font:MediumBoldSystemFont" color="0xFFFFFFFF" />
            <Label text="(OK to Toggle, Down to Done)" translation="[100, 90]" font="font:SmallSystemFont" color="0xAAAAAAFF" />
            
            <MarkupGrid id="camGrid" translation="[100, 150]" 
                        itemComponentName="CamGridItem" 
                        itemSize="[320, 260]" 
                        numColumns="4" 
                        numRows="3"
                        vertFocusAnimationStyle="fixedFocus" 
                        drawFocusFeedback="true"/>
            <Button id="doneBtn" text="Done" translation="[850, 950]" minWidth="200" />
        </Group>

        <VideoScene id="videoScene" visible="false" />
    </children>
</component>
