<?xml version="1.0" encoding="utf-8" ?>
<component name="NetworkTask" extends="Task">
    <interface>
        <field id="url" type="string" />
        <field id="response" type="assocarray" />
    </interface>

    <script type="text/brightscript">
        <![CDATA[
        sub init()
            m.top.functionName = "execute"
        end sub

        sub execute()
            url = m.top.url
            request = CreateObject("roUrlTransfer")
            request.SetCertificatesFile("common:/certs/ca-bundle.crt")
            request.InitClientCertificates()
            request.SetUrl(url)
            
            ' SecuritySpy JSON handling
            jsonStr = request.GetToString()
            
            if jsonStr <> ""
                ' Sanity check: Ensure response looks like JSON before parsing to prevent crash on HTML (e.g. Login Page)
                firstChar = Left(jsonStr.Trim(), 1)
                
                if firstChar = "{" or firstChar = "["
                    json = ParseJson(jsonStr)
                    if json <> invalid
                        m.top.response = { success: true, data: json }
                    else
                        m.top.response = { success: false, error: "Invalid JSON Structure" }
                    end if
                else
                    ' Debug: Print the first 100 chars to see what HTML we got
                    print ">>> [NetworkTask] Server returned non-JSON: " + Left(jsonStr, 100)
                    m.top.response = { success: false, error: "Server returned HTML (Check Auth)" }
                end if
            else
                m.top.response = { success: false, error: "Request Failed (Empty Response)" }
            end if
        end sub
        ]]>
    </script>
</component>